# .github/workflows/pr-chromatic.yml
name: PR Visual & CI Checks - Ultimate PAL

on:
    pull_request:
        branches: [main, develop, release/*]

jobs:
    lint:
        name: Lint & Type Check
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-node@v3
              with:
                  node-version: "20"
            - run: npm ci
            - run: npm run lint
            - run: npm run type-check

    test:
        name: Unit & Integration Tests
        runs-on: ubuntu-latest
        needs: lint
        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-node@v3
              with:
                  node-version: "20"
            - run: npm ci
            - name: Run Vitest Unit Tests
              run: npm run test:unit -- --coverage
            - name: Run E2E Playwright Tests
              run: npm run test:e2e -- --headless

    storybook:
        name: Build Storybook
        runs-on: ubuntu-latest
        needs: test
        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-node@v3
              with:
                  node-version: "20"
            - run: npm ci
            - name: Build Storybook Static
              run: npm run build-storybook

    chromatic:
        name: Chromatic Visual Regression
        runs-on: ubuntu-latest
        needs: storybook
        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-node@v3
              with:
                  node-version: "20"
            - run: npm ci
            - name: Publish Storybook to Chromatic
              uses: chromaui/action@v1
              with:
                  projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
                  storybookBuildDir: ./storybook-static
                  exitZeroOnChanges: false
                  autoAcceptChanges: false
                  args: >
                      --only-changed
                      --exit-once-uploaded
                      --exit-zero-on-changes
                      --diff-config "{\"critical\":true}"
