<div class="ui-table-container">
    <!-- Loading overlay -->
    @if (loading) {
    <div class="ui-table-loading">
        <ui-progress-spinner size="md"></ui-progress-spinner>
    </div>
    }

    <!-- Premium Toolbar -->
    @if (searchable || exportable) {
    <div class="ui-table-toolbar">
        @if (searchable) {
        <div class="ui-table-toolbar__search">
            <ui-form-field appearance="outline" [label]="i18n.searchPlaceholder" class="ui-table-search-field">
                <span uiPrefix>
                    <mat-icon>search</mat-icon>
                </span>
                <ui-input uiInput (input)="applyFilter($event)" class="ui-table-search-input">
                </ui-input>
            </ui-form-field>
        </div>
        }

        @if (exportable) {
        <div class="ui-table-toolbar__actions">
            <!-- Bulk Actions -->
            @if (selectable) {
            <ui-button variant="ghost" size="sm" [disabled]="selection.selected.length < 2" (clicked)="clearSelection()"
                [matTooltip]="i18n.clearSelectionTooltip">
                <mat-icon>close</mat-icon>
            </ui-button>
            <ui-button variant="ghost" size="sm" [disabled]="selection.selected.length < 2" (clicked)="onBulkDelete()"
                [matTooltip]="selection.selected.length >= 2 ? (i18n.bulkDeleteConfirmButton + ' ' + selection.selected.length + ' ' + (i18n.itemsSelectedLabel || '')) : i18n.bulkDeleteTooltip">
                <mat-icon [color]="selection.selected.length >= 2 ? 'warn' : ''">delete</mat-icon>
            </ui-button>
            }

            <!-- Column Visibility Picker -->
            <ui-button variant="ghost" size="sm" [matMenuTriggerFor]="columnMenu" [matTooltip]="i18n.columnsButton">
                <mat-icon>view_column</mat-icon>
            </ui-button>
            <mat-menu #columnMenu="matMenu" class="ui-table-column-menu">
                <div class="ui-table-column-menu__header">{{ i18n.columnsMenuTitle }}</div>
                <mat-divider></mat-divider>
                @for (col of columns; track col.key) {
                <div mat-menu-item (click)="$event.stopPropagation()">
                    <ui-checkbox [checked]="isColumnVisible(col.key)" (toggle)="toggleColumnVisibility(col.key)">
                        {{ col.header }}
                    </ui-checkbox>
                </div>
                }
            </mat-menu>

            <ui-button variant="outline" size="sm" (clicked)="exportToCsv()">
                <mat-icon class="export-icon">download</mat-icon>
                {{ i18n.exportButton }}
            </ui-button>
        </div>
        }
    </div>
    }

    <div class="ui-table-scroll-container">
        <table mat-table [dataSource]="dataSource" matSort class="ui-table">

            <!-- Checkbox Column -->
            <ng-container matColumnDef="__select">
                <th mat-header-cell *matHeaderCellDef class="select-col">
                    <ui-checkbox (toggle)="toggleAllRows()" [checked]="selection.hasValue() && isAllSelected()">
                    </ui-checkbox>
                </th>
                <td mat-cell *matCellDef="let row" class="select-col">
                    <ui-checkbox (click)="$event.stopPropagation()" (toggle)="selection.toggle(row)"
                        [checked]="selection.isSelected(row)">
                    </ui-checkbox>
                </td>
            </ng-container>

            <!-- Column Defs -->
            @for (col of columns; track col.key) {
            <ng-container [matColumnDef]="col.key">
                <th mat-header-cell *matHeaderCellDef mat-sort-header [disabled]="!col.sortable"
                    [class]="'align-' + (col.align || 'left')">
                    {{ col.header }}
                </th>
                <td mat-cell *matCellDef="let row" [class]="'align-' + (col.align || 'left')">
                    @switch (col.type) {
                    @case ('badge') {
                    <ui-tag [variant]="getBadgeClass(getValue(row, col))" [icon]="getBadgeIcon(getValue(row, col))"
                        appearance="soft">
                        {{ getValue(row, col) }}
                    </ui-tag>
                    }
                    @case ('avatar') {
                    <div class="ui-table-avatar-cell">
                        <img [src]="row[col.imageProperty || 'avatar'] || 'assets/images/default-avatar.png'"
                            class="ui-table-avatar"
                            onerror="this.src='https://ui-avatars.com/api/?name=' + encodeURIComponent(getValue(row, col))">
                        <span class="ui-table-avatar-text">{{ getValue(row, col) }}</span>
                    </div>
                    }
                    @case ('icon') {
                    <div class="ui-table-icon-cell">
                        <mat-icon class="ui-table-cell-icon">{{ row[col.iconProperty || 'icon'] }}</mat-icon>
                        <span>{{ getValue(row, col) }}</span>
                    </div>
                    }
                    @default {
                    {{ getValue(row, col) }}
                    }
                    }
                </td>
            </ng-container>
            }

            <!-- Actions Column -->
            <ng-container matColumnDef="__actions">
                <th mat-header-cell *matHeaderCellDef class="actions-header">{{ i18n.actionsHeader }}</th>
                <td mat-cell *matCellDef="let row" class="actions-cell">
                    @for (action of actions; track action.icon) {
                    <button mat-icon-button [color]="action.color || 'primary'" [matTooltip]="action.tooltip || ''"
                        (click)="$event.stopPropagation(); action.action(row)">
                        <mat-icon>{{ action.icon }}</mat-icon>
                    </button>
                    }
                </td>
            </ng-container>

            <!-- Header Row -->
            <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: stickyHeader"></tr>

            <!-- Data Row -->
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" (click)="onRowClick(row)" class="ui-table-row">
            </tr>

            <!-- No Data Row -->
            <tr class="mat-row" *matNoDataRow>
                <td class="mat-cell no-data" [attr.colspan]="displayedColumns.length">
                    <div class="ui-table-empty">
                        <mat-icon>inventory_2</mat-icon>
                        <p>{{ i18n.noDataMessage }}</p>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <!-- Pagination -->
    <mat-paginator [pageSize]="pageSize" [pageSizeOptions]="pageSizeOptions" class="ui-paginator">
    </mat-paginator>
</div>